{% extends "base.html" %}
{% block title %}Dashboard - BriteCo Reddit Tracker{% endblock %}

{% block content %}
<!-- Suggest Reply Modal -->
<div class="modal fade" id="replyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #272d3f; color: #fff;">
                <h6 class="modal-title"><i class="bi bi-robot me-2"></i>AI Suggested Reply</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label text-muted" style="font-size: 0.8rem;">Original comment by <strong id="replyAuthor"></strong></label>
                    <div class="p-2 bg-light rounded" style="font-size: 0.9rem;" id="replyOriginal"></div>
                </div>
                <div>
                    <label class="form-label text-muted" style="font-size: 0.8rem;">Suggested reply</label>
                    <div id="replyLoading" class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-secondary"></div>
                        <span class="ms-2 text-muted">Generating reply...</span>
                    </div>
                    <textarea class="form-control" id="replySuggestion" rows="4" style="display:none;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-sm btn-teal" onclick="copyReply()">
                    <i class="bi bi-clipboard me-1"></i>Copy to Clipboard
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Stats Row -->
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card stat-card p-3">
            <div class="stat-label">Total Posts</div>
            <div class="stat-number" id="statPosts">-</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card p-3">
            <div class="stat-label">Total Comments</div>
            <div class="stat-number" id="statComments">-</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card highlight p-3">
            <div class="stat-label">New Today</div>
            <div class="stat-number" id="statNewToday">-</div>
        </div>
    </div>
</div>

<!-- Toolbar -->
<div class="filter-bar d-flex align-items-center gap-2">
    <div id="activeFilters" class="d-flex flex-wrap gap-1"></div>
    <div class="ms-auto d-flex gap-2">
        <button class="btn btn-sm btn-outline-secondary" onclick="runScrape()" id="btnScrape" title="Scrape Reddit for new comments">
            <i class="bi bi-arrow-clockwise me-1"></i>Sync Data
        </button>
        <button class="btn btn-sm btn-outline-secondary" onclick="runSentimentAnalysis()" id="btnSentiment" title="Analyze sentiment with AI">
            <i class="bi bi-emoji-smile me-1"></i>Analyze Sentiment
        </button>
        <button class="btn btn-sm btn-outline-secondary" onclick="exportCSV()" title="Export filtered comments to CSV">
            <i class="bi bi-download me-1"></i>Export CSV
        </button>
    </div>
</div>

<!-- Hidden filter state elements -->
<select class="d-none" id="filterPost"><option value="">All Posts</option></select>
<input type="hidden" id="filterSentiment" value="">
<input type="hidden" id="filterAuthor" value="">
<input type="hidden" id="filterReplyStatus" value="needs_reply">
<input type="hidden" id="filterDateFrom" value="">
<input type="hidden" id="filterDateTo" value="">
<input type="hidden" id="filterSortBy" value="date_desc">

<!-- Status Tabs -->
<ul class="nav nav-tabs status-tabs mt-3" id="statusTabs">
    <li class="nav-item">
        <a class="nav-link active" href="#" onclick="setStatusTab('needs_reply'); return false;" data-tab="needs_reply">
            Needs Reply <span class="badge bg-info ms-1" id="tabCountNeedsReply">0</span>
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="#" onclick="setStatusTab('replied'); return false;" data-tab="replied">
            Replied <span class="badge bg-success ms-1" id="tabCountReplied">0</span>
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="#" onclick="setStatusTab('ignored'); return false;" data-tab="ignored">
            Ignored <span class="badge bg-secondary ms-1" id="tabCountIgnored">0</span>
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="#" onclick="setStatusTab(''); return false;" data-tab="">
            All <span class="badge bg-dark ms-1" id="tabCountAll">0</span>
        </a>
    </li>
</ul>

<!-- Select All Banner -->
<div class="select-all-banner" id="selectAllBanner" style="display: none;">
    <span id="selectAllBannerText">All 25 on this page are selected.</span>
    <a href="#" id="selectAllFilterLink" onclick="selectAllInFilter(); return false;">Select all <span id="selectAllFilterCount">0</span> matching this filter</a>
    <span id="selectAllFilterDone" style="display: none;">All <span id="selectAllFilterDoneCount">0</span> selected.</span>
</div>

<!-- Comments Table -->
<div class="comments-table">
    <table class="table table-hover mb-0">
        <thead>
            <tr>
                <th style="width: 40px;"><input type="checkbox" class="form-check-input" id="selectAll" onchange="toggleSelectAll(this.checked)"></th>
                <th class="col-header" data-col="post">
                    <div class="dropdown d-inline">
                        <span class="col-header-btn" data-bs-toggle="dropdown" data-bs-auto-close="outside" role="button">
                            Post <i class="bi bi-chevron-down ms-1" style="font-size: 0.65rem;"></i>
                        </span>
                        <div class="dropdown-menu col-dropdown p-2" style="min-width: 240px;">
                            <div class="mb-2"><small class="text-muted fw-bold">SORT</small></div>
                            <a class="dropdown-item rounded" href="#" onclick="setSort('post'); return false;"><i class="bi bi-sort-alpha-down me-2"></i>Sort A-Z</a>
                            <hr class="my-2">
                            <div class="mb-2"><small class="text-muted fw-bold">FILTER BY POST</small></div>
                            <select class="form-select form-select-sm" id="headerFilterPost" onchange="setFilter('post', this.value)">
                                <option value="">All Posts</option>
                            </select>
                        </div>
                    </div>
                </th>
                <th>Comment</th>
                <th class="col-header" data-col="author">
                    <div class="dropdown d-inline">
                        <span class="col-header-btn" data-bs-toggle="dropdown" data-bs-auto-close="outside" role="button">
                            Author <i class="bi bi-chevron-down ms-1" style="font-size: 0.65rem;"></i>
                        </span>
                        <div class="dropdown-menu col-dropdown p-2" style="min-width: 240px;">
                            <div class="mb-2"><small class="text-muted fw-bold">SORT</small></div>
                            <a class="dropdown-item rounded" href="#" onclick="setSort('author'); return false;"><i class="bi bi-sort-alpha-down me-2"></i>Sort A-Z</a>
                            <hr class="my-2">
                            <div class="mb-2"><small class="text-muted fw-bold">FILTER BY AUTHOR</small></div>
                            <select class="form-select form-select-sm" id="headerFilterAuthor" onchange="setFilter('author', this.value)">
                                <option value="">All Authors</option>
                            </select>
                        </div>
                    </div>
                </th>
                <th class="col-header" data-col="sentiment">
                    <div class="dropdown d-inline">
                        <span class="col-header-btn" data-bs-toggle="dropdown" data-bs-auto-close="outside" role="button">
                            Sentiment <i class="bi bi-chevron-down ms-1" style="font-size: 0.65rem;"></i>
                        </span>
                        <div class="dropdown-menu col-dropdown p-2">
                            <div class="mb-2"><small class="text-muted fw-bold">SORT</small></div>
                            <a class="dropdown-item rounded" href="#" onclick="setSort('sentiment'); return false;"><i class="bi bi-sort-down me-2"></i>Sort by Sentiment</a>
                            <hr class="my-2">
                            <div class="mb-2"><small class="text-muted fw-bold">FILTER</small></div>
                            <a class="dropdown-item rounded" href="#" onclick="setFilter('sentiment', ''); return false;"><i class="bi bi-circle me-2"></i>All</a>
                            <a class="dropdown-item rounded" href="#" onclick="setFilter('sentiment', 'positive'); return false;"><i class="bi bi-emoji-smile text-success me-2"></i>Positive</a>
                            <a class="dropdown-item rounded" href="#" onclick="setFilter('sentiment', 'negative'); return false;"><i class="bi bi-emoji-frown text-danger me-2"></i>Negative</a>
                            <a class="dropdown-item rounded" href="#" onclick="setFilter('sentiment', 'question'); return false;"><i class="bi bi-question-circle text-warning me-2"></i>Question</a>
                            <a class="dropdown-item rounded" href="#" onclick="setFilter('sentiment', 'neutral'); return false;"><i class="bi bi-dash-circle text-secondary me-2"></i>Neutral</a>
                        </div>
                    </div>
                </th>
                <th>Status</th>
                <th class="col-header" data-col="date">
                    <div class="dropdown d-inline">
                        <span class="col-header-btn" data-bs-toggle="dropdown" data-bs-auto-close="outside" role="button">
                            Date <i class="bi bi-chevron-down ms-1" style="font-size: 0.65rem;"></i>
                        </span>
                        <div class="dropdown-menu col-dropdown p-2">
                            <div class="mb-2"><small class="text-muted fw-bold">SORT</small></div>
                            <a class="dropdown-item rounded" href="#" onclick="setSort('date_desc'); return false;"><i class="bi bi-sort-down me-2"></i>Newest first</a>
                            <a class="dropdown-item rounded" href="#" onclick="setSort('date_asc'); return false;"><i class="bi bi-sort-up me-2"></i>Oldest first</a>
                            <hr class="my-2">
                            <div class="mb-2"><small class="text-muted fw-bold">DATE RANGE</small></div>
                            <label class="form-label mb-1" style="font-size: 0.75rem;">From</label>
                            <input type="date" class="form-control form-control-sm mb-2" id="headerDateFrom" onchange="setFilter('dateFrom', this.value)">
                            <label class="form-label mb-1" style="font-size: 0.75rem;">To</label>
                            <input type="date" class="form-control form-control-sm" id="headerDateTo" onchange="setFilter('dateTo', this.value)">
                        </div>
                    </div>
                </th>
                <th style="width: 110px;">Actions</th>
            </tr>
        </thead>
        <tbody id="commentsBody">
            <tr>
                <td colspan="7" class="empty-state">
                    <i class="bi bi-chat-dots"></i>
                    <p>No comments yet. Data will sync automatically.</p>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Pagination -->
<nav class="mt-3 mb-5 pb-4 d-flex justify-content-between align-items-center">
    <div class="text-muted" style="font-size: 0.85rem;" id="paginationInfo">-</div>
    <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
</nav>

<!-- Bulk Action Bar -->
<div class="bulk-action-bar" id="bulkActionBar" style="display: none;">
    <div class="d-flex align-items-center gap-3">
        <span class="fw-500" id="bulkCount">0 selected</span>
        <button class="btn btn-sm btn-success" onclick="bulkSetStatus('replied')">
            <i class="bi bi-check-circle me-1"></i>Mark Replied
        </button>
        <button class="btn btn-sm btn-secondary" onclick="bulkSetStatus('ignored')">
            <i class="bi bi-x-circle me-1"></i>Mark Ignored
        </button>
        <button class="btn btn-sm btn-info" onclick="bulkSetStatus('needs_reply')">
            <i class="bi bi-chat-dots me-1"></i>Mark Needs Reply
        </button>
        <a href="#" class="text-muted ms-2" style="font-size: 0.85rem;" onclick="clearSelection(); return false;">Clear</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    const perPage = 25;
    const selectedIds = new Set();
    let currentComments = [];

    const sentimentColors = {
        positive: 'success',
        negative: 'danger',
        question: 'warning',
        neutral: 'secondary'
    };
    const sentimentIcons = {
        positive: 'bi-emoji-smile',
        negative: 'bi-emoji-frown',
        question: 'bi-question-circle',
        neutral: 'bi-dash-circle'
    };
    const statusColors = {
        needs_reply: 'info',
        replied: 'success',
        ignored: 'secondary'
    };
    const statusLabels = {
        needs_reply: 'Needs Reply',
        replied: 'Replied',
        ignored: 'Ignored'
    };

    // --- Load stats ---
    async function loadStats() {
        try {
            const res = await fetch('/api/stats');
            const data = await res.json();
            document.getElementById('statPosts').textContent = data.total_posts;
            document.getElementById('statComments').textContent = data.total_comments;
            document.getElementById('statNewToday').textContent = data.new_today;
            // Update tab counts
            document.getElementById('tabCountNeedsReply').textContent = data.needs_reply_count || 0;
            document.getElementById('tabCountReplied').textContent = data.replied_count || 0;
            document.getElementById('tabCountIgnored').textContent = data.ignored_count || 0;
            document.getElementById('tabCountAll').textContent = data.total_comments || 0;
        } catch (e) {
            console.error('Failed to load stats:', e);
        }
    }

    // --- Load posts for filter dropdown ---
    async function loadPosts() {
        try {
            const res = await fetch('/api/posts');
            const posts = await res.json();
            const withComments = posts.filter(p => p.comment_count > 0);
            const selects = [document.getElementById('filterPost'), document.getElementById('headerFilterPost')];
            selects.forEach(select => {
                if (!select) return;
                const current = select.value;
                select.innerHTML = '<option value="">All Posts</option>';
                withComments.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    const title = p.title.length > 45 ? p.title.substring(0, 45) + '...' : p.title;
                    opt.textContent = `${title} (${p.comment_count})`;
                    select.appendChild(opt);
                });
                select.value = current;
            });
        } catch (e) {
            console.error('Failed to load posts:', e);
        }
    }

    // --- Load authors for filter dropdown ---
    async function loadAuthors() {
        try {
            const res = await fetch('/api/authors');
            const authors = await res.json();
            const select = document.getElementById('headerFilterAuthor');
            if (!select) return;
            const current = select.value;
            select.innerHTML = '<option value="">All Authors</option>';
            authors.forEach(a => {
                const opt = document.createElement('option');
                opt.value = a.author;
                opt.textContent = `u/${a.author} (${a.comment_count})`;
                select.appendChild(opt);
            });
            select.value = current;
        } catch (e) {
            console.error('Failed to load authors:', e);
        }
    }

    // --- Column header filter/sort actions ---
    function setSort(sortBy) {
        document.getElementById('filterSortBy').value = sortBy;
        loadComments(1);
        updateActiveFilters();
    }

    function setFilter(type, value) {
        if (type === 'post') {
            document.getElementById('filterPost').value = value;
            document.getElementById('headerFilterPost').value = value;
        } else if (type === 'sentiment') {
            document.getElementById('filterSentiment').value = value;
        } else if (type === 'author') {
            document.getElementById('filterAuthor').value = value;
            document.getElementById('headerFilterAuthor').value = value;
        } else if (type === 'status') {
            document.getElementById('filterReplyStatus').value = value;
        } else if (type === 'dateFrom') {
            document.getElementById('filterDateFrom').value = value;
        } else if (type === 'dateTo') {
            document.getElementById('filterDateTo').value = value;
        }
        loadComments(1);
        updateActiveFilters();
    }

    function updateActiveFilters() {
        const container = document.getElementById('activeFilters');
        let chips = [];
        const post = document.getElementById('filterPost');
        const postVal = post.value;
        if (postVal) {
            const postText = post.options[post.selectedIndex]?.textContent || 'Post';
            chips.push({label: postText, clear: () => setFilter('post', '')});
        }
        const sent = document.getElementById('filterSentiment').value;
        if (sent) chips.push({label: `Sentiment: ${sent}`, clear: () => setFilter('sentiment', '')});
        const auth = document.getElementById('filterAuthor').value;
        if (auth) chips.push({label: `Author: u/${auth}`, clear: () => setFilter('author', '')});
        const df = document.getElementById('filterDateFrom').value;
        if (df) chips.push({label: `From: ${df}`, clear: () => { document.getElementById('headerDateFrom').value = ''; setFilter('dateFrom', ''); }});
        const dt = document.getElementById('filterDateTo').value;
        if (dt) chips.push({label: `To: ${dt}`, clear: () => { document.getElementById('headerDateTo').value = ''; setFilter('dateTo', ''); }});
        const sort = document.getElementById('filterSortBy').value;
        if (sort !== 'date_desc') {
            const sortLabels = {date_asc: 'Oldest first', sentiment: 'By sentiment', post: 'By post', author: 'By author'};
            chips.push({label: `Sort: ${sortLabels[sort] || sort}`, clear: () => setSort('date_desc')});
        }

        if (chips.length === 0) {
            container.innerHTML = '';
            return;
        }

        container.innerHTML = chips.map((c, i) =>
            `<span class="badge bg-light text-dark border" style="font-size: 0.75rem; font-weight: 500;">
                ${escapeHtml(c.label)}
                <i class="bi bi-x ms-1" role="button" onclick="activeFilterClear[${i}]()"></i>
            </span>`
        ).join('') + `<span class="badge bg-transparent text-teal" role="button" style="font-size: 0.75rem; cursor:pointer;" onclick="clearFilters()">Clear all</span>`;

        window.activeFilterClear = chips.map(c => c.clear);
    }

    // --- Build filter URL params ---
    function getFilterParams() {
        const postId = document.getElementById('filterPost').value;
        const dateFrom = document.getElementById('filterDateFrom').value;
        const dateTo = document.getElementById('filterDateTo').value;
        const sentiment = document.getElementById('filterSentiment').value;
        const author = document.getElementById('filterAuthor').value;
        const replyStatus = document.getElementById('filterReplyStatus').value;
        const sortBy = document.getElementById('filterSortBy').value;

        let params = '';
        if (postId) params += `&post_id=${encodeURIComponent(postId)}`;
        if (dateFrom) params += `&date_from=${dateFrom}`;
        if (dateTo) params += `&date_to=${dateTo}`;
        if (sentiment) params += `&sentiment=${sentiment}`;
        if (author) params += `&author=${encodeURIComponent(author)}`;
        if (replyStatus) params += `&reply_status=${replyStatus}`;
        if (sortBy) params += `&sort_by=${sortBy}`;
        return params;
    }

    // --- Load comments ---
    async function loadComments(page = 1) {
        currentPage = page;
        let url = `/api/comments?page=${page}&per_page=${perPage}${getFilterParams()}`;

        try {
            const res = await fetch(url);
            const data = await res.json();
            renderComments(data.comments);
            renderPagination(data.page, data.total_pages, data.total);
        } catch (e) {
            console.error('Failed to load comments:', e);
        }
    }

    function renderComments(comments) {
        const tbody = document.getElementById('commentsBody');
        currentComments = comments;

        if (!comments.length) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="empty-state">
                        <i class="bi bi-chat-dots"></i>
                        <p>No comments found matching your filters.</p>
                    </td>
                </tr>`;
            return;
        }

        tbody.innerHTML = comments.map(c => {
            const date = new Date(c.created_utc * 1000);
            const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            const postTitle = c.post_title.length > 40 ? c.post_title.substring(0, 40) + '...' : c.post_title;
            const body = c.body.length > 100 ? c.body.substring(0, 100) + '...' : c.body;
            const redditLink = c.post_url || '#';

            const sent = c.sentiment || 'neutral';
            const sentColor = sentimentColors[sent] || 'secondary';
            const sentIcon = sentimentIcons[sent] || 'bi-dash-circle';

            const checked = selectedIds.has(c.id) ? 'checked' : '';

            return `
                <tr class="${checked ? 'table-active' : ''}">
                    <td><input type="checkbox" class="form-check-input row-check" data-id="${c.id}" ${checked} onchange="toggleSelect('${c.id}', this.checked)"></td>
                    <td>
                        <div style="font-weight: 500; font-size: 0.85rem;">${escapeHtml(postTitle)}</div>
                        <span class="badge-subreddit">r/${escapeHtml(c.subreddit)}</span>
                    </td>
                    <td class="comment-body" title="${escapeHtml(c.body)}" style="max-width: 300px;">${escapeHtml(body)}</td>
                    <td>
                        <span class="author-link" onclick="toggleSelectByAuthor('${escapeAttr(c.author || '')}')">
                            <strong style="font-size: 0.85rem;">u/${escapeHtml(c.author || '[deleted]')}</strong>
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-${sentColor}" style="font-size: 0.75rem;">
                            <i class="bi ${sentIcon} me-1"></i>${sent}
                        </span>
                    </td>
                    <td>
                        <select class="form-select form-select-sm status-select" style="font-size: 0.75rem; width: auto; padding: 2px 24px 2px 6px;" onchange="setReplyStatus('${c.id}', this.value)">
                            <option value="needs_reply" ${c.reply_status === 'needs_reply' ? 'selected' : ''}>Needs Reply</option>
                            <option value="replied" ${c.reply_status === 'replied' ? 'selected' : ''}>Replied</option>
                            <option value="ignored" ${c.reply_status === 'ignored' ? 'selected' : ''}>Ignored</option>
                        </select>
                    </td>
                    <td style="white-space: nowrap; font-size: 0.8rem; color: #666;">${dateStr}</td>
                    <td>
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-outline-teal" title="Suggest Reply" onclick="openSuggestReply('${escapeAttr(c.body)}', '${escapeAttr(c.post_title)}', '${escapeAttr(c.author || '')}')">
                                <i class="bi bi-robot"></i>
                            </button>
                            <a href="${escapeHtml(redditLink)}" target="_blank" class="btn btn-sm btn-outline-secondary" title="View on Reddit">
                                <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                        </div>
                    </td>
                </tr>`;
        }).join('');

        // Update select-all checkbox state
        const allChecked = comments.length > 0 && comments.every(c => selectedIds.has(c.id));
        document.getElementById('selectAll').checked = allChecked;
    }

    function renderPagination(page, totalPages, total) {
        const info = document.getElementById('paginationInfo');
        const start = (page - 1) * perPage + 1;
        const end = Math.min(page * perPage, total);
        info.textContent = total > 0 ? `Showing ${start}-${end} of ${total} comments` : 'No comments';

        const nav = document.getElementById('pagination');
        if (totalPages <= 1) { nav.innerHTML = ''; return; }

        let html = '';
        html += `<li class="page-item ${page === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadComments(${page-1}); return false;">&laquo;</a>
                 </li>`;

        for (let i = Math.max(1, page - 2); i <= Math.min(totalPages, page + 2); i++) {
            html += `<li class="page-item ${i === page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadComments(${i}); return false;">${i}</a>
                     </li>`;
        }

        html += `<li class="page-item ${page === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadComments(${page+1}); return false;">&raquo;</a>
                 </li>`;

        nav.innerHTML = html;
    }

    // --- Actions ---
    function applyFilters() { loadComments(1); }

    function clearFilters() {
        document.getElementById('filterPost').value = '';
        document.getElementById('filterDateFrom').value = '';
        document.getElementById('filterDateTo').value = '';
        document.getElementById('filterSentiment').value = '';
        document.getElementById('filterAuthor').value = '';
        document.getElementById('filterReplyStatus').value = 'needs_reply';
        const ha = document.getElementById('headerFilterAuthor');
        if (ha) ha.value = '';
        document.getElementById('filterSortBy').value = 'date_desc';
        const hp = document.getElementById('headerFilterPost');
        if (hp) hp.value = '';
        const hdf = document.getElementById('headerDateFrom');
        if (hdf) hdf.value = '';
        const hdt = document.getElementById('headerDateTo');
        if (hdt) hdt.value = '';
        // Reset tab to Needs Reply
        document.querySelectorAll('#statusTabs .nav-link').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.tab === 'needs_reply');
        });
        clearSelection();
        loadComments(1);
        updateActiveFilters();
    }

    async function setReplyStatus(commentId, status) {
        try {
            await fetch(`/api/comments/${commentId}/reply-status`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reply_status: status })
            });
            loadComments(currentPage);
            loadStats();
        } catch (e) {
            alert('Failed to update status: ' + e.message);
        }
    }

    // --- Status Tabs ---
    function setStatusTab(status) {
        document.getElementById('filterReplyStatus').value = status;
        // Update tab active state
        document.querySelectorAll('#statusTabs .nav-link').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.tab === status);
        });
        clearSelection();
        loadComments(1);
        updateActiveFilters();
    }

    // --- Selection ---
    function toggleSelect(id, checked) {
        if (checked) {
            selectedIds.add(id);
        } else {
            selectedIds.delete(id);
        }
        updateBulkBar();
        // Highlight row
        const checkbox = document.querySelector(`input[data-id="${id}"]`);
        if (checkbox) checkbox.closest('tr').classList.toggle('table-active', checked);
        // Update select-all
        const allChecked = currentComments.length > 0 && currentComments.every(c => selectedIds.has(c.id));
        document.getElementById('selectAll').checked = allChecked;
    }

    function toggleSelectAll(checked) {
        currentComments.forEach(c => {
            if (checked) {
                selectedIds.add(c.id);
            } else {
                selectedIds.delete(c.id);
            }
        });
        // Update all checkboxes
        document.querySelectorAll('.row-check').forEach(cb => {
            cb.checked = checked;
            cb.closest('tr').classList.toggle('table-active', checked);
        });
        updateBulkBar();

        // Show/hide select-all-in-filter banner
        const banner = document.getElementById('selectAllBanner');
        if (checked && currentComments.length >= perPage) {
            banner.style.display = 'block';
            document.getElementById('selectAllFilterLink').style.display = '';
            document.getElementById('selectAllFilterDone').style.display = 'none';
            document.getElementById('selectAllBannerText').textContent = `All ${currentComments.length} on this page are selected.`;
            // Fetch total count for filter
            fetch(`/api/comments/ids?${getFilterParams().substring(1)}`)
                .then(r => r.json())
                .then(data => {
                    document.getElementById('selectAllFilterCount').textContent = data.total;
                    if (data.total <= currentComments.length) {
                        banner.style.display = 'none';
                    }
                });
        } else {
            banner.style.display = 'none';
        }
    }

    async function selectAllInFilter() {
        try {
            const res = await fetch(`/api/comments/ids?${getFilterParams().substring(1)}`);
            const data = await res.json();
            data.ids.forEach(id => selectedIds.add(id));
            updateBulkBar();
            // Update banner
            document.getElementById('selectAllFilterLink').style.display = 'none';
            document.getElementById('selectAllFilterDone').style.display = '';
            document.getElementById('selectAllFilterDoneCount').textContent = data.total;
        } catch (e) {
            alert('Failed to select all: ' + e.message);
        }
    }

    function toggleSelectByAuthor(author) {
        const authorComments = currentComments.filter(c => (c.author || '') === author);
        const allSelected = authorComments.every(c => selectedIds.has(c.id));

        authorComments.forEach(c => {
            if (allSelected) {
                selectedIds.delete(c.id);
            } else {
                selectedIds.add(c.id);
            }
        });

        // Re-render checkboxes
        document.querySelectorAll('.row-check').forEach(cb => {
            const id = cb.dataset.id;
            cb.checked = selectedIds.has(id);
            cb.closest('tr').classList.toggle('table-active', selectedIds.has(id));
        });
        const allPageChecked = currentComments.length > 0 && currentComments.every(c => selectedIds.has(c.id));
        document.getElementById('selectAll').checked = allPageChecked;
        updateBulkBar();
    }

    function clearSelection() {
        selectedIds.clear();
        document.querySelectorAll('.row-check').forEach(cb => {
            cb.checked = false;
            cb.closest('tr').classList.remove('table-active');
        });
        document.getElementById('selectAll').checked = false;
        document.getElementById('selectAllBanner').style.display = 'none';
        updateBulkBar();
    }

    function updateBulkBar() {
        const bar = document.getElementById('bulkActionBar');
        const count = selectedIds.size;
        if (count > 0) {
            bar.style.display = 'block';
            document.getElementById('bulkCount').textContent = `${count} selected`;
        } else {
            bar.style.display = 'none';
        }
    }

    async function bulkSetStatus(status) {
        if (selectedIds.size === 0) return;
        try {
            const res = await fetch('/api/comments/bulk-status', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comment_ids: Array.from(selectedIds), reply_status: status })
            });
            const data = await res.json();
            if (data.success) {
                clearSelection();
                loadComments(currentPage);
                loadStats();
            } else {
                alert('Bulk update failed: ' + (data.error || 'Unknown error'));
            }
        } catch (e) {
            alert('Bulk update failed: ' + e.message);
        }
    }

    // --- AI Suggest Reply ---
    async function openSuggestReply(body, postTitle, author) {
        document.getElementById('replyAuthor').textContent = 'u/' + author;
        document.getElementById('replyOriginal').textContent = body;
        document.getElementById('replyLoading').style.display = 'block';
        document.getElementById('replySuggestion').style.display = 'none';
        const oldAlert = document.getElementById('replyNoAction');
        if (oldAlert) oldAlert.remove();
        const copyBtn = document.querySelector('#replyModal .btn-teal');
        if (copyBtn) copyBtn.style.display = '';

        const modal = new bootstrap.Modal(document.getElementById('replyModal'));
        modal.show();

        try {
            const res = await fetch('/api/ai/suggest-reply', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comment_body: body, post_title: postTitle, author: author })
            });
            const data = await res.json();

            document.getElementById('replyLoading').style.display = 'none';
            const textarea = document.getElementById('replySuggestion');
            const copyBtn = document.querySelector('#replyModal .btn-teal');

            if (data.success && data.reply.includes('[NO REPLY NEEDED]')) {
                textarea.style.display = 'none';
                const alert = document.createElement('div');
                alert.className = 'alert alert-info mb-0';
                alert.id = 'replyNoAction';
                alert.innerHTML = '<i class="bi bi-info-circle me-2"></i>No reply recommended â€” this comment doesn\'t need a brand response.';
                textarea.parentNode.appendChild(alert);
                copyBtn.style.display = 'none';
            } else {
                textarea.style.display = 'block';
                copyBtn.style.display = '';
                const existing = document.getElementById('replyNoAction');
                if (existing) existing.remove();

                if (data.success) {
                    textarea.value = data.reply;
                } else {
                    textarea.value = 'Error: ' + (data.error || 'Failed to generate reply');
                }
            }
        } catch (e) {
            document.getElementById('replyLoading').style.display = 'none';
            document.getElementById('replySuggestion').style.display = 'block';
            document.getElementById('replySuggestion').value = 'Request failed: ' + e.message;
        }
    }

    function copyReply() {
        const text = document.getElementById('replySuggestion').value;
        navigator.clipboard.writeText(text).then(() => {
            alert('Reply copied to clipboard!');
        });
    }

    // --- Sentiment Analysis ---
    async function runSentimentAnalysis() {
        const btn = document.getElementById('btnSentiment');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Analyzing...';

        try {
            const res = await fetch('/api/ai/analyze-sentiment', { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                alert(`Analyzed ${data.analyzed} comments`);
                loadComments(currentPage);
            } else {
                alert('Failed: ' + (data.error || 'Unknown error'));
            }
        } catch (e) {
            alert('Request failed: ' + e.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-emoji-smile me-1"></i>Analyze Sentiment';
        }
    }

    // --- CSV Export ---
    function exportCSV() {
        let url = `/api/export/csv?${getFilterParams().substring(1)}`;
        window.location.href = url;
    }

    // --- Scrape ---
    async function runScrape() {
        const btn = document.getElementById('btnScrape');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Syncing...';

        try {
            const res = await fetch('/api/scrape/run', { method: 'POST' });
            const data = await res.json();

            if (data.success) {
                const msg = `Found ${data.new_comments} new comment${data.new_comments !== 1 ? 's' : ''} across ${data.posts_found} posts`;
                alert(msg);
                loadStats();
                loadComments(1);
                document.getElementById('filterPost').innerHTML = '<option value="">All Posts</option>';
                loadPosts();
            } else {
                alert('Scrape failed: ' + (data.error || 'Unknown error'));
            }
        } catch (e) {
            alert('Scrape request failed: ' + e.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Sync Data';
        }
    }

    // --- Helpers ---
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text || '';
        return div.innerHTML;
    }

    function escapeAttr(text) {
        return (text || '').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, ' ');
    }

    function timeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 60) return 'just now';
        if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
        if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
        return Math.floor(seconds / 86400) + 'd ago';
    }

    // --- Init ---
    loadStats();
    loadPosts();
    loadAuthors();
    loadComments(1);  // Defaults to needs_reply tab
</script>
{% endblock %}
