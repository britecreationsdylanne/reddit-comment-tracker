{% extends "base.html" %}
{% block title %}Dashboard - BriteCo Reddit Tracker{% endblock %}

{% block content %}
<!-- Suggest Reply Modal -->
<div class="modal fade" id="replyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #272d3f; color: #fff;">
                <h6 class="modal-title"><i class="bi bi-robot me-2"></i>AI Suggested Reply</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label text-muted" style="font-size: 0.8rem;">Original comment by <strong id="replyAuthor"></strong></label>
                    <div class="p-2 bg-light rounded" style="font-size: 0.9rem;" id="replyOriginal"></div>
                </div>
                <div>
                    <label class="form-label text-muted" style="font-size: 0.8rem;">Suggested reply</label>
                    <div id="replyLoading" class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-secondary"></div>
                        <span class="ms-2 text-muted">Generating reply...</span>
                    </div>
                    <textarea class="form-control" id="replySuggestion" rows="4" style="display:none;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-sm btn-teal" onclick="copyReply()">
                    <i class="bi bi-clipboard me-1"></i>Copy to Clipboard
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Stats Row -->
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card stat-card p-3">
            <div class="stat-label">Total Posts</div>
            <div class="stat-number" id="statPosts">-</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card p-3">
            <div class="stat-label">Total Comments</div>
            <div class="stat-number" id="statComments">-</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card highlight p-3">
            <div class="stat-label">New Today</div>
            <div class="stat-number" id="statNewToday">-</div>
        </div>
    </div>
</div>

<!-- Toolbar -->
<div class="filter-bar d-flex align-items-center gap-2">
    <div id="activeFilters" class="d-flex flex-wrap gap-1"></div>
    <div class="ms-auto d-flex gap-2">
        <button class="btn btn-sm btn-outline-secondary" onclick="runSentimentAnalysis()" id="btnSentiment" title="Analyze sentiment with AI">
            <i class="bi bi-emoji-smile me-1"></i>Analyze Sentiment
        </button>
        <button class="btn btn-sm btn-outline-secondary" onclick="exportCSV()" title="Export filtered comments to CSV">
            <i class="bi bi-download me-1"></i>Export CSV
        </button>
    </div>
</div>

<!-- Hidden filter state elements -->
<select class="d-none" id="filterPost"><option value="">All Posts</option></select>
<input type="hidden" id="filterSentiment" value="">
<input type="hidden" id="filterReplyStatus" value="">
<input type="hidden" id="filterDateFrom" value="">
<input type="hidden" id="filterDateTo" value="">
<input type="hidden" id="filterSortBy" value="date_desc">

<!-- Comments Table -->
<div class="comments-table mt-3">
    <table class="table table-hover mb-0">
        <thead>
            <tr>
                <th class="col-header" data-col="post">
                    <div class="dropdown d-inline">
                        <span class="col-header-btn" data-bs-toggle="dropdown" data-bs-auto-close="outside" role="button">
                            Post <i class="bi bi-chevron-down ms-1" style="font-size: 0.65rem;"></i>
                        </span>
                        <div class="dropdown-menu col-dropdown p-2" style="min-width: 240px;">
                            <div class="mb-2"><small class="text-muted fw-bold">SORT</small></div>
                            <a class="dropdown-item rounded" href="#" onclick="setSort('post'); return false;"><i class="bi bi-sort-alpha-down me-2"></i>Sort A-Z</a>
                            <hr class="my-2">
                            <div class="mb-2"><small class="text-muted fw-bold">FILTER BY POST</small></div>
                            <select class="form-select form-select-sm" id="headerFilterPost" onchange="setFilter('post', this.value)">
                                <option value="">All Posts</option>
                            </select>
                        </div>
                    </div>
                </th>
                <th>Comment</th>
                <th class="col-header" data-col="author">
                    <div class="dropdown d-inline">
                        <span class="col-header-btn" data-bs-toggle="dropdown" role="button">
                            Author <i class="bi bi-chevron-down ms-1" style="font-size: 0.65rem;"></i>
                        </span>
                        <div class="dropdown-menu col-dropdown p-2">
                            <a class="dropdown-item rounded" href="#" onclick="setSort('author'); return false;"><i class="bi bi-sort-alpha-down me-2"></i>Sort A-Z</a>
                        </div>
                    </div>
                </th>
                <th class="col-header" data-col="sentiment">
                    <div class="dropdown d-inline">
                        <span class="col-header-btn" data-bs-toggle="dropdown" data-bs-auto-close="outside" role="button">
                            Sentiment <i class="bi bi-chevron-down ms-1" style="font-size: 0.65rem;"></i>
                        </span>
                        <div class="dropdown-menu col-dropdown p-2">
                            <div class="mb-2"><small class="text-muted fw-bold">SORT</small></div>
                            <a class="dropdown-item rounded" href="#" onclick="setSort('sentiment'); return false;"><i class="bi bi-sort-down me-2"></i>Sort by Sentiment</a>
                            <hr class="my-2">
                            <div class="mb-2"><small class="text-muted fw-bold">FILTER</small></div>
                            <a class="dropdown-item rounded" href="#" onclick="setFilter('sentiment', ''); return false;"><i class="bi bi-circle me-2"></i>All</a>
                            <a class="dropdown-item rounded" href="#" onclick="setFilter('sentiment', 'positive'); return false;"><i class="bi bi-emoji-smile text-success me-2"></i>Positive</a>
                            <a class="dropdown-item rounded" href="#" onclick="setFilter('sentiment', 'negative'); return false;"><i class="bi bi-emoji-frown text-danger me-2"></i>Negative</a>
                            <a class="dropdown-item rounded" href="#" onclick="setFilter('sentiment', 'question'); return false;"><i class="bi bi-question-circle text-warning me-2"></i>Question</a>
                            <a class="dropdown-item rounded" href="#" onclick="setFilter('sentiment', 'neutral'); return false;"><i class="bi bi-dash-circle text-secondary me-2"></i>Neutral</a>
                        </div>
                    </div>
                </th>
                <th class="col-header" data-col="status">
                    <div class="dropdown d-inline">
                        <span class="col-header-btn" data-bs-toggle="dropdown" data-bs-auto-close="outside" role="button">
                            Status <i class="bi bi-chevron-down ms-1" style="font-size: 0.65rem;"></i>
                        </span>
                        <div class="dropdown-menu col-dropdown p-2">
                            <a class="dropdown-item rounded" href="#" onclick="setFilter('status', ''); return false;"><i class="bi bi-circle me-2"></i>All</a>
                            <a class="dropdown-item rounded" href="#" onclick="setFilter('status', 'needs_reply'); return false;"><i class="bi bi-chat-dots text-info me-2"></i>Needs Reply</a>
                            <a class="dropdown-item rounded" href="#" onclick="setFilter('status', 'replied'); return false;"><i class="bi bi-check-circle text-success me-2"></i>Replied</a>
                            <a class="dropdown-item rounded" href="#" onclick="setFilter('status', 'ignored'); return false;"><i class="bi bi-x-circle text-secondary me-2"></i>Ignored</a>
                        </div>
                    </div>
                </th>
                <th class="col-header" data-col="date">
                    <div class="dropdown d-inline">
                        <span class="col-header-btn" data-bs-toggle="dropdown" data-bs-auto-close="outside" role="button">
                            Date <i class="bi bi-chevron-down ms-1" style="font-size: 0.65rem;"></i>
                        </span>
                        <div class="dropdown-menu col-dropdown p-2">
                            <div class="mb-2"><small class="text-muted fw-bold">SORT</small></div>
                            <a class="dropdown-item rounded" href="#" onclick="setSort('date_desc'); return false;"><i class="bi bi-sort-down me-2"></i>Newest first</a>
                            <a class="dropdown-item rounded" href="#" onclick="setSort('date_asc'); return false;"><i class="bi bi-sort-up me-2"></i>Oldest first</a>
                            <hr class="my-2">
                            <div class="mb-2"><small class="text-muted fw-bold">DATE RANGE</small></div>
                            <label class="form-label mb-1" style="font-size: 0.75rem;">From</label>
                            <input type="date" class="form-control form-control-sm mb-2" id="headerDateFrom" onchange="setFilter('dateFrom', this.value)">
                            <label class="form-label mb-1" style="font-size: 0.75rem;">To</label>
                            <input type="date" class="form-control form-control-sm" id="headerDateTo" onchange="setFilter('dateTo', this.value)">
                        </div>
                    </div>
                </th>
                <th style="width: 110px;">Actions</th>
            </tr>
        </thead>
        <tbody id="commentsBody">
            <tr>
                <td colspan="7" class="empty-state">
                    <i class="bi bi-chat-dots"></i>
                    <p>No comments yet. Data will sync automatically.</p>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Pagination -->
<nav class="mt-3 mb-5 pb-4 d-flex justify-content-between align-items-center">
    <div class="text-muted" style="font-size: 0.85rem;" id="paginationInfo">-</div>
    <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
</nav>
{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    const perPage = 25;

    const sentimentColors = {
        positive: 'success',
        negative: 'danger',
        question: 'warning',
        neutral: 'secondary'
    };
    const sentimentIcons = {
        positive: 'bi-emoji-smile',
        negative: 'bi-emoji-frown',
        question: 'bi-question-circle',
        neutral: 'bi-dash-circle'
    };
    const statusColors = {
        needs_reply: 'info',
        replied: 'success',
        ignored: 'secondary'
    };
    const statusLabels = {
        needs_reply: 'Needs Reply',
        replied: 'Replied',
        ignored: 'Ignored'
    };

    // --- Load stats ---
    async function loadStats() {
        try {
            const res = await fetch('/api/stats');
            const data = await res.json();
            document.getElementById('statPosts').textContent = data.total_posts;
            document.getElementById('statComments').textContent = data.total_comments;
            document.getElementById('statNewToday').textContent = data.new_today;
        } catch (e) {
            console.error('Failed to load stats:', e);
        }
    }

    // --- Load posts for filter dropdown ---
    async function loadPosts() {
        try {
            const res = await fetch('/api/posts');
            const posts = await res.json();
            const withComments = posts.filter(p => p.comment_count > 0);
            const selects = [document.getElementById('filterPost'), document.getElementById('headerFilterPost')];
            selects.forEach(select => {
                if (!select) return;
                const current = select.value;
                select.innerHTML = '<option value="">All Posts</option>';
                withComments.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    const title = p.title.length > 45 ? p.title.substring(0, 45) + '...' : p.title;
                    opt.textContent = `${title} (${p.comment_count})`;
                    select.appendChild(opt);
                });
                select.value = current;
            });
        } catch (e) {
            console.error('Failed to load posts:', e);
        }
    }

    // --- Column header filter/sort actions ---
    function setSort(sortBy) {
        document.getElementById('filterSortBy').value = sortBy;
        loadComments(1);
        updateActiveFilters();
    }

    function setFilter(type, value) {
        if (type === 'post') {
            document.getElementById('filterPost').value = value;
            document.getElementById('headerFilterPost').value = value;
        } else if (type === 'sentiment') {
            document.getElementById('filterSentiment').value = value;
        } else if (type === 'status') {
            document.getElementById('filterReplyStatus').value = value;
        } else if (type === 'dateFrom') {
            document.getElementById('filterDateFrom').value = value;
        } else if (type === 'dateTo') {
            document.getElementById('filterDateTo').value = value;
        }
        loadComments(1);
        updateActiveFilters();
    }

    function updateActiveFilters() {
        const container = document.getElementById('activeFilters');
        let chips = [];
        const post = document.getElementById('filterPost');
        const postVal = post.value;
        if (postVal) {
            const postText = post.options[post.selectedIndex]?.textContent || 'Post';
            chips.push({label: postText, clear: () => setFilter('post', '')});
        }
        const sent = document.getElementById('filterSentiment').value;
        if (sent) chips.push({label: `Sentiment: ${sent}`, clear: () => setFilter('sentiment', '')});
        const status = document.getElementById('filterReplyStatus').value;
        if (status) chips.push({label: `Status: ${status.replace('_', ' ')}`, clear: () => setFilter('status', '')});
        const df = document.getElementById('filterDateFrom').value;
        if (df) chips.push({label: `From: ${df}`, clear: () => { document.getElementById('headerDateFrom').value = ''; setFilter('dateFrom', ''); }});
        const dt = document.getElementById('filterDateTo').value;
        if (dt) chips.push({label: `To: ${dt}`, clear: () => { document.getElementById('headerDateTo').value = ''; setFilter('dateTo', ''); }});
        const sort = document.getElementById('filterSortBy').value;
        if (sort !== 'date_desc') {
            const sortLabels = {date_asc: 'Oldest first', sentiment: 'By sentiment', post: 'By post', author: 'By author'};
            chips.push({label: `Sort: ${sortLabels[sort] || sort}`, clear: () => setSort('date_desc')});
        }

        if (chips.length === 0) {
            container.innerHTML = '';
            return;
        }

        container.innerHTML = chips.map((c, i) =>
            `<span class="badge bg-light text-dark border" style="font-size: 0.75rem; font-weight: 500;">
                ${escapeHtml(c.label)}
                <i class="bi bi-x ms-1" role="button" onclick="activeFilterClear[${i}]()"></i>
            </span>`
        ).join('') + `<span class="badge bg-transparent text-teal" role="button" style="font-size: 0.75rem; cursor:pointer;" onclick="clearFilters()">Clear all</span>`;

        window.activeFilterClear = chips.map(c => c.clear);
    }

    // --- Build filter URL params ---
    function getFilterParams() {
        const postId = document.getElementById('filterPost').value;
        const dateFrom = document.getElementById('filterDateFrom').value;
        const dateTo = document.getElementById('filterDateTo').value;
        const sentiment = document.getElementById('filterSentiment').value;
        const replyStatus = document.getElementById('filterReplyStatus').value;
        const sortBy = document.getElementById('filterSortBy').value;

        let params = '';
        if (postId) params += `&post_id=${encodeURIComponent(postId)}`;
        if (dateFrom) params += `&date_from=${dateFrom}`;
        if (dateTo) params += `&date_to=${dateTo}`;
        if (sentiment) params += `&sentiment=${sentiment}`;
        if (replyStatus) params += `&reply_status=${replyStatus}`;
        if (sortBy) params += `&sort_by=${sortBy}`;
        return params;
    }

    // --- Load comments ---
    async function loadComments(page = 1) {
        currentPage = page;
        let url = `/api/comments?page=${page}&per_page=${perPage}${getFilterParams()}`;

        try {
            const res = await fetch(url);
            const data = await res.json();
            renderComments(data.comments);
            renderPagination(data.page, data.total_pages, data.total);
        } catch (e) {
            console.error('Failed to load comments:', e);
        }
    }

    function renderComments(comments) {
        const tbody = document.getElementById('commentsBody');

        if (!comments.length) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="empty-state">
                        <i class="bi bi-chat-dots"></i>
                        <p>No comments found matching your filters.</p>
                    </td>
                </tr>`;
            return;
        }

        tbody.innerHTML = comments.map(c => {
            const date = new Date(c.created_utc * 1000);
            const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            const postTitle = c.post_title.length > 40 ? c.post_title.substring(0, 40) + '...' : c.post_title;
            const body = c.body.length > 100 ? c.body.substring(0, 100) + '...' : c.body;
            const redditLink = c.post_url || '#';

            const sent = c.sentiment || 'neutral';
            const sentColor = sentimentColors[sent] || 'secondary';
            const sentIcon = sentimentIcons[sent] || 'bi-dash-circle';

            const status = c.reply_status || 'needs_reply';
            const statColor = statusColors[status] || 'secondary';
            const statLabel = statusLabels[status] || status;

            // Build status dropdown options
            const statusOpts = ['needs_reply', 'replied', 'ignored'].map(s =>
                `<li><a class="dropdown-item ${s === status ? 'active' : ''}" href="#" onclick="setReplyStatus('${c.id}', '${s}'); return false;">${statusLabels[s]}</a></li>`
            ).join('');

            return `
                <tr>
                    <td>
                        <div style="font-weight: 500; font-size: 0.85rem;">${escapeHtml(postTitle)}</div>
                        <span class="badge-subreddit">r/${escapeHtml(c.subreddit)}</span>
                    </td>
                    <td class="comment-body" title="${escapeHtml(c.body)}" style="max-width: 300px;">${escapeHtml(body)}</td>
                    <td><strong style="font-size: 0.85rem;">u/${escapeHtml(c.author || '[deleted]')}</strong></td>
                    <td>
                        <span class="badge bg-${sentColor}" style="font-size: 0.75rem;">
                            <i class="bi ${sentIcon} me-1"></i>${sent}
                        </span>
                    </td>
                    <td>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-${statColor} dropdown-toggle" data-bs-toggle="dropdown" style="font-size: 0.75rem;">
                                ${statLabel}
                            </button>
                            <ul class="dropdown-menu dropdown-menu-sm">${statusOpts}</ul>
                        </div>
                    </td>
                    <td style="white-space: nowrap; font-size: 0.8rem; color: #666;">${dateStr}</td>
                    <td>
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-outline-teal" title="Suggest Reply" onclick="openSuggestReply('${escapeAttr(c.body)}', '${escapeAttr(c.post_title)}', '${escapeAttr(c.author || '')}')">
                                <i class="bi bi-robot"></i>
                            </button>
                            <a href="${escapeHtml(redditLink)}" target="_blank" class="btn btn-sm btn-outline-secondary" title="View on Reddit">
                                <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                        </div>
                    </td>
                </tr>`;
        }).join('');
    }

    function renderPagination(page, totalPages, total) {
        const info = document.getElementById('paginationInfo');
        const start = (page - 1) * perPage + 1;
        const end = Math.min(page * perPage, total);
        info.textContent = total > 0 ? `Showing ${start}-${end} of ${total} comments` : 'No comments';

        const nav = document.getElementById('pagination');
        if (totalPages <= 1) { nav.innerHTML = ''; return; }

        let html = '';
        html += `<li class="page-item ${page === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadComments(${page-1}); return false;">&laquo;</a>
                 </li>`;

        for (let i = Math.max(1, page - 2); i <= Math.min(totalPages, page + 2); i++) {
            html += `<li class="page-item ${i === page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadComments(${i}); return false;">${i}</a>
                     </li>`;
        }

        html += `<li class="page-item ${page === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadComments(${page+1}); return false;">&raquo;</a>
                 </li>`;

        nav.innerHTML = html;
    }

    // --- Actions ---
    function applyFilters() { loadComments(1); }

    function clearFilters() {
        document.getElementById('filterPost').value = '';
        document.getElementById('filterDateFrom').value = '';
        document.getElementById('filterDateTo').value = '';
        document.getElementById('filterSentiment').value = '';
        document.getElementById('filterReplyStatus').value = '';
        document.getElementById('filterSortBy').value = 'date_desc';
        const hp = document.getElementById('headerFilterPost');
        if (hp) hp.value = '';
        const hdf = document.getElementById('headerDateFrom');
        if (hdf) hdf.value = '';
        const hdt = document.getElementById('headerDateTo');
        if (hdt) hdt.value = '';
        loadComments(1);
        updateActiveFilters();
    }

    async function setReplyStatus(commentId, status) {
        try {
            await fetch(`/api/comments/${commentId}/reply-status`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reply_status: status })
            });
            loadComments(currentPage);
        } catch (e) {
            alert('Failed to update status: ' + e.message);
        }
    }

    // --- AI Suggest Reply ---
    async function openSuggestReply(body, postTitle, author) {
        document.getElementById('replyAuthor').textContent = 'u/' + author;
        document.getElementById('replyOriginal').textContent = body;
        document.getElementById('replyLoading').style.display = 'block';
        document.getElementById('replySuggestion').style.display = 'none';
        const oldAlert = document.getElementById('replyNoAction');
        if (oldAlert) oldAlert.remove();
        const copyBtn = document.querySelector('#replyModal .btn-teal');
        if (copyBtn) copyBtn.style.display = '';

        const modal = new bootstrap.Modal(document.getElementById('replyModal'));
        modal.show();

        try {
            const res = await fetch('/api/ai/suggest-reply', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comment_body: body, post_title: postTitle, author: author })
            });
            const data = await res.json();

            document.getElementById('replyLoading').style.display = 'none';
            const textarea = document.getElementById('replySuggestion');
            const copyBtn = document.querySelector('#replyModal .btn-teal');

            if (data.success && data.reply.includes('[NO REPLY NEEDED]')) {
                textarea.style.display = 'none';
                const alert = document.createElement('div');
                alert.className = 'alert alert-info mb-0';
                alert.id = 'replyNoAction';
                alert.innerHTML = '<i class="bi bi-info-circle me-2"></i>No reply recommended â€” this comment doesn\'t need a brand response.';
                textarea.parentNode.appendChild(alert);
                copyBtn.style.display = 'none';
            } else {
                textarea.style.display = 'block';
                copyBtn.style.display = '';
                const existing = document.getElementById('replyNoAction');
                if (existing) existing.remove();

                if (data.success) {
                    textarea.value = data.reply;
                } else {
                    textarea.value = 'Error: ' + (data.error || 'Failed to generate reply');
                }
            }
        } catch (e) {
            document.getElementById('replyLoading').style.display = 'none';
            document.getElementById('replySuggestion').style.display = 'block';
            document.getElementById('replySuggestion').value = 'Request failed: ' + e.message;
        }
    }

    function copyReply() {
        const text = document.getElementById('replySuggestion').value;
        navigator.clipboard.writeText(text).then(() => {
            alert('Reply copied to clipboard!');
        });
    }

    // --- Sentiment Analysis ---
    async function runSentimentAnalysis() {
        const btn = document.getElementById('btnSentiment');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Analyzing...';

        try {
            const res = await fetch('/api/ai/analyze-sentiment', { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                alert(`Analyzed ${data.analyzed} comments`);
                loadComments(currentPage);
            } else {
                alert('Failed: ' + (data.error || 'Unknown error'));
            }
        } catch (e) {
            alert('Request failed: ' + e.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-emoji-smile me-1"></i>Analyze Sentiment';
        }
    }

    // --- CSV Export ---
    function exportCSV() {
        let url = `/api/export/csv?${getFilterParams().substring(1)}`;
        window.location.href = url;
    }

    // --- Scrape ---
    async function runScrape() {
        const btn = document.getElementById('btnScrape');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Scraping...';

        try {
            const res = await fetch('/api/scrape/run', { method: 'POST' });
            const data = await res.json();

            if (data.success) {
                const msg = `Found ${data.new_comments} new comment${data.new_comments !== 1 ? 's' : ''} across ${data.posts_found} posts`;
                alert(msg);
                loadStats();
                loadComments(1);
                document.getElementById('filterPost').innerHTML = '<option value="">All Posts</option>';
                loadPosts();
            } else {
                alert('Scrape failed: ' + (data.error || 'Unknown error'));
            }
        } catch (e) {
            alert('Scrape request failed: ' + e.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Run Scrape Now';
        }
    }

    // --- Helpers ---
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text || '';
        return div.innerHTML;
    }

    function escapeAttr(text) {
        return (text || '').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, ' ');
    }

    function timeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 60) return 'just now';
        if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
        if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
        return Math.floor(seconds / 86400) + 'd ago';
    }

    // --- Init ---
    loadStats();
    loadPosts();
    loadComments(1);
</script>
{% endblock %}
